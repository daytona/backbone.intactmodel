!function(t,i){"use strict";"function"==typeof define&&define.amd?define(["underscore","backbone"],function(t,e){return i(t,e)}):"object"==typeof exports?module.exports=i(require("underscore"),require("backbone")):i(t._,t.Backbone)}(this,function(t,i){"use strict";var e=function(t,e){return this.properties=this.properties||{},this.derived=this.derived||{},this.session={},i.Model.call(this,t,e)};t.extend(e.prototype,i.Model.prototype,{validate:function(i,e){var n=t.keys(i),r=t.bind(s,this)(i,e);return n.length!==t.keys(r.attributes).length?new Error("One or more attributes are not valid."):void 0},toJSON:function(i){var e=this,s={};return t(this.derived).forEach(function(n,r){t.isFunction(n)&&(s[r]=n.call(e,i))}),t.extend(t.clone(this.attributes),t.clone(this.session),s)},get:function(i){var e,s=[this.attributes,this.session,this.derived];return t(s).forEach(function(t){e=e||t[i]}),t.isFunction(e)?e.call(this):e},clear:function(i){var e,s={},n=t.clone(this.session);return i=i||{},i.graceful||t.extend(n,this.attributes),t(n).forEach(function(t,i){s[i]=e}),this.set(s,t.extend({},i,{unset:!0}))},changedAttributes:function(i){if(!i)return this.hasChanged()?t.clone(this.changed):!1;var e,s=!1,n=this._changing?this._previousAttributes:t.extend({},this.attributes,this.session);for(var r in i)t.isEqual(n[r],e=i[r])||((s||(s={}))[r]=e);return s},set:function(i,e,n){var r,h,o,a,u,c,d,l,f;if(!i)return this;if(a=t.bind(function(i,e,s){t.isEqual(this[i][s],e)||d.push(s),t.isEqual(f[s],e)?delete this.changed[s]:this.changed[s]=e,u?delete this[i][s]:this[i][s]=e},this),t.isObject(i)?(r=i,n=e):(r={})[i]=e,n=n||{},!this._validate(r,n))return!1;if(r=t.bind(s,this)(r,n),h=r.attributes,o=r.session,u=n.unset,c=n.silent,d=[],l=this._changing,this._changing=!0,l||(this._previousAttributes=t.extend({},this.attributes,this.session),this.changed={}),f=this._previousAttributes,t.has(h,this.idAttribute)&&(this.id=h[this.idAttribute]),t(r).forEach(function(i,e){t(i).forEach(t.partial(a,e))}),!c){d.length&&(this._pending=n);for(var g=0,p=d.length;p>g;g+=1)this.trigger("change:"+d[g],this,r[d[g]]||o[d[g]],n)}if(l)return this;if(!c)for(;this._pending;)n=this._pending,this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},save:function(i,e,r){var h,o,a,u=this.attributes,c=this.session;if(t.isObject(i)?(h=i,r=e):(h={})[i]=e,r=t.extend({validate:!0},r),h&&!r.wait){if(!this.set(h,r))return!1}else if(!this._validate(h,r))return!1;h=t.bind(s,this)(h,r),h&&r.wait&&(this.attributes=t.extend({},u,h.attributes),this.session=t.extend({},c,h.session)),void 0===r.parse&&(r.parse=!0);var d=this,l=r.success;return r.success=function(i){d.attributes=u;var e=d.parse(i,r);return r.wait&&(e=t.extend(h.attributes||{},e)),t.isObject(e)&&!d.set(e,r)?!1:(l&&l(d,i,r),void d.trigger("sync",d,i,r))},n(this,r),o=this.isNew()?"create":r.patch?"patch":"update","patch"===o&&(r.attrs=h.attributes),a=this.sync(o,this,r),h.attributes&&r.wait&&(this.attributes=u),a}}),e.extend=i.Model.extend,i.IntactModel=e,i.Collection.prototype._prepareModel=function(i,e){if(t.isFunction(i.initialize))return i.collection||(i.collection=this),i;e=e||{},e.collection=this;var s=new this.model(i,e);return s._validate(i,e)?s:(this.trigger("invalid",this,i,e),!1)};var s=function(i){var e={},s=this.properties,n=this.idAttribute;return i=t.clone(i),t(i).forEach(function(r,h){var o,a=s[h];if(h!==n){if(t.isUndefined(a))return e[h]=r,void delete i[h];o=a.type.replace("integer","number"),o=o.slice(0,1).toUpperCase()+o.slice(1,o.length),t.isUndefined(r)||t["is"+o](r)||delete i[h]}}),{attributes:i,session:e}},n=function(t,i){var e=i.error;i.error=function(s){e&&e(t,s,i),t.trigger("error",t,s,i)}};return e});