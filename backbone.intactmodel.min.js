!function(t,e){"use strict";"function"==typeof define&&define.amd?define(["underscore","backbone"],function(t,i){return e(t,i)}):"object"==typeof exports?module.exports=e(require("underscore"),require("backbone")):e(t._,t.Backbone)}(this,function(t,e){"use strict";var i=function(t,i){return this.session={},e.Model.call(this,t,i)};t.extend(i.prototype,e.Model.prototype,{validate:function(e){var i=t.keys(e),s=t.bind(o,this)(e);return i.length!==t.keys(s.attributes).length?new Error("One or more attributes are not valid."):void 0},compile:function(e){var i=this,s={};return t(t.result(this,"derived")).each(function(n,r){t.isFunction(n)&&(s[r]=n.call(i,e))}),t.extend(t.clone(this.attributes),t.clone(this.session),s)},get:function(e){for(var i,s=t.result(this,"derived")||{},n=[this.attributes,this.session,s],r=0,o=n.length;o>r;r+=1)if(n[r].hasOwnProperty(e)){i=n[r][e];break}return t.isFunction(i)?i.call(this):i},isComplete:function(){var e=this.attributes,i=t.keys(t.result(this,"properties"));return!i.length||t.every(i,t.bind(e.hasOwnProperty,e))},clear:function(e){var i,s={},n=t.clone(this.session);return e=e||{},e.graceful||t.extend(n,this.attributes),t(n).each(function(t,e){s[e]=i}),this.set(s,t.extend({},e,{unset:!0}))},changedAttributes:function(e){if(!e)return this.hasChanged()?t.clone(this.changed):!1;var i,s=!1,n=this._changing?this._previousAttributes:t.extend({},this.attributes,this.session);for(var r in e)t.isEqual(n[r],i=e[r])||((s||(s={}))[r]=i);return s},set:function(e,i,s){var n,r,a,u,h,c,d,l,p;if(!e)return this;if(u=t.bind(function(e,i,s){t.isEqual(this[e][s],i)||d.push(s),t.isEqual(p[s],i)?delete this.changed[s]:this.changed[s]=i,h?delete this[e][s]:this[e][s]=i},this),t.isObject(e)?(n=e,s=i):(n={})[e]=i,s=s||{},!this._validate(n,s))return!1;if(n=t.bind(o,this)(n),r=n.attributes,a=n.session,h=s.unset,c=s.silent,d=[],l=this._changing,this._changing=!0,l||(this._previousAttributes=t.extend({},this.attributes,this.session),this.changed={}),p=this._previousAttributes,t.has(r,this.idAttribute)&&(this.id=r[this.idAttribute]),t(n).each(function(e,i){t(e).each(t.partial(u,i))}),!c){d.length&&(this._pending=s);for(var f=0,b=d.length;b>f;f+=1)this.trigger("change:"+d[f],this,this.get(d[f]),s)}if(l)return this;if(!c)for(;this._pending;)s=this._pending,this._pending=!1,this.trigger("change",this,s);return this._pending=!1,this._changing=!1,this},save:function(e,i,s){var n,r,u,h=this.attributes,c=this.session;if(t.isObject(e)?(n=e,s=i):(n={})[e]=i,s=t.extend({validate:!0},s),n&&!s.wait){if(!this.set(n,s))return!1}else if(!this._validate(n,s))return!1;n=t.bind(o,this)(n),n&&s.wait&&(this.attributes=t.extend({},h,n.attributes),this.session=t.extend({},c,n.session)),void 0===s.parse&&(s.parse=!0);var d=this,l=s.success;return s.success=function(e){d.attributes=h;var i=d.parse(e,s);return s.wait&&(i=t.extend(n.attributes||{},i)),t.isObject(i)&&!d.set(i,s)?!1:(l&&l(d,e,s),void d.trigger("sync",d,e,s))},a(this,s),r=this.isNew()?"create":s.patch?"patch":"update","patch"===r&&(s.attrs=n.attributes),u=this.sync(r,this,s),n.attributes&&s.wait&&(this.attributes=h),u}});var s=["keys","values","pairs","invert","pick","omit"];t.each(s,function(e){i.prototype[e]=function(){var i=Array.prototype.slice.call(arguments);return i.unshift(this.compile()),t[e].apply(t,i)}});var n=function(e,i){if(!t.isObject(e))return e;var s;for(s in i)i.hasOwnProperty(s)&&(e[s]=e.hasOwnProperty(s)&&t.isObject(e[s])&&t.isObject(i[s]&&!t.isFunction(e[s])&&!t.isFunction(i[s]))?n(e[s],i[s]):i[s]);return e},r=function(e,i){var s,r=this;s=e&&t.has(e,"constructor")?e.constructor:function(){return r.apply(this,arguments)},t.extend(s,r,i);var o=function(){this.constructor=s};return o.prototype=r.prototype,s.prototype=new o,e&&n(s.prototype,e),s.__super__=r.prototype,s};i.extend=r,e.IntactModel=i,e.Collection.prototype._prepareModel=function(e,i){if(t.isFunction(e.initialize))return e.collection||(e.collection=this),e;i=i||{},i.collection=this;var s=new this.model(e,i);return s._validate(e,i)?s:(this.trigger("invalid",this,e,i),!1)};var o=function(e){var i={},s=t.result(this,"properties"),n=this.idAttribute;return e=t.clone(e),s&&t(e).each(function(r,o){var a,u=s[o];if(o!==n){if(t.isUndefined(u))return i[o]=r,void delete e[o];a=u.type.replace("integer","number"),a=a.slice(0,1).toUpperCase()+a.slice(1,a.length),t.isUndefined(r)||t["is"+a](r)||delete e[o]}}),{attributes:e,session:i}},a=function(t,e){var i=e.error;e.error=function(s){i&&i(t,s,e),t.trigger("error",t,s,e)}};return i});