!function(t,e){"use strict";"function"==typeof define&&define.amd?define(["underscore","backbone"],function(t,i){return e(t,i)}):"object"==typeof exports?module.exports=e(require("underscore"),require("backbone")):e(t._,t.Backbone)}(this,function(t,e){"use strict";var i=function(i,s){return this.properties=t.clone(this.properties||{}),this.derived=t.clone(this.derived||{}),this.session={},e.Model.call(this,i,s)};t.extend(i.prototype,e.Model.prototype,{validate:function(e){var i=t.keys(e),s=t.bind(n,this)(e);return i.length!==t.keys(s.attributes).length?new Error("One or more attributes are not valid."):void 0},compile:function(e){var i=this,s={};return t(this.derived).each(function(r,n){t.isFunction(r)&&(s[n]=r.call(i,e))}),t.extend(t.clone(this.attributes),t.clone(this.session),s)},get:function(e){for(var i,s=[this.attributes,this.session,this.derived],r=0,n=s.length;n>r;r+=1)if(s[r].hasOwnProperty(e)){i=s[r][e];break}return t.isFunction(i)?i.call(this):i},isComplete:function(){var e=this.attributes,i=t.keys(this.properties);return t.every(i,function(t){return e.hasOwnProperty(t)})},clear:function(e){var i,s={},r=t.clone(this.session);return e=e||{},e.graceful||t.extend(r,this.attributes),t(r).each(function(t,e){s[e]=i}),this.set(s,t.extend({},e,{unset:!0}))},changedAttributes:function(e){if(!e)return this.hasChanged()?t.clone(this.changed):!1;var i,s=!1,r=this._changing?this._previousAttributes:t.extend({},this.attributes,this.session);for(var n in e)t.isEqual(r[n],i=e[n])||((s||(s={}))[n]=i);return s},set:function(e,i,s){var r,o,a,h,u,c,d,l,p;if(!e)return this;if(h=t.bind(function(e,i,s){t.isEqual(this[e][s],i)||d.push(s),t.isEqual(p[s],i)?delete this.changed[s]:this.changed[s]=i,u?delete this[e][s]:this[e][s]=i},this),t.isObject(e)?(r=e,s=i):(r={})[e]=i,s=s||{},!this._validate(r,s))return!1;if(r=t.bind(n,this)(r),o=r.attributes,a=r.session,u=s.unset,c=s.silent,d=[],l=this._changing,this._changing=!0,l||(this._previousAttributes=t.extend({},this.attributes,this.session),this.changed={}),p=this._previousAttributes,t.has(o,this.idAttribute)&&(this.id=o[this.idAttribute]),t(r).each(function(e,i){t(e).each(t.partial(h,i))}),!c){d.length&&(this._pending=s);for(var f=0,v=d.length;v>f;f+=1)this.trigger("change:"+d[f],this,this.get(d[f]),s)}if(l)return this;if(!c)for(;this._pending;)s=this._pending,this._pending=!1,this.trigger("change",this,s);return this._pending=!1,this._changing=!1,this},save:function(e,i,s){var r,a,h,u=this.attributes,c=this.session;if(!e||t.isObject(e)?(r=e,s=i):(r={})[e]=i,s=t.extend({validate:!0},s),r&&!s.wait){if(!this.set(r,s))return!1}else if(!this._validate(r,s))return!1;r=t.bind(n,this)(r),r&&s.wait&&(this.attributes=t.extend({},u,r.attributes),this.session=t.extend({},c,r.session)),void 0===s.parse&&(s.parse=!0);var d=this,l=s.success;return s.success=function(e){d.attributes=u;var i=d.parse(e,s);return s.wait&&(i=t.extend(r.attributes||{},i)),t.isObject(i)&&!d.set(i,s)?!1:(l&&l(d,e,s),void d.trigger("sync",d,e,s))},o(this,s),a=this.isNew()?"create":s.patch?"patch":"update","patch"===a&&(s.attrs=r.attributes),h=this.sync(a,this,s),r.attributes&&s.wait&&(this.attributes=u),h}});var s=["keys","values","pairs","invert","pick","omit"];t.each(s,function(e){i.prototype[e]=function(){var i=Array.prototype.slice.call(arguments);return i.unshift(this.compile()),t[e].apply(t,i)}});var r=function(i,s){var r=e.Model.extend.call(this,i,s);return t.defaults(r.prototype.defaults,this.prototype.defaults),t.defaults(r.prototype.properties,this.prototype.properties),t.defaults(r.prototype.derived,this.prototype.derived),r};i.extend=r,e.IntactModel=i,e.Collection.prototype._prepareModel=function(e,i){if(t.isFunction(e.initialize))return e.collection||(e.collection=this),e;i=i||{},i.collection=this;var s=new this.model(e,i);return s._validate(e,i)?s:(this.trigger("invalid",this,e,i),!1)};var n=function(e){var i={},s=this.properties,r=this.idAttribute;return e=t.clone(e),t(e).each(function(n,o){var a,h=s[o];if(o!==r){if(t.isUndefined(h))return i[o]=n,void delete e[o];a=h.type.replace("integer","number"),a=a.slice(0,1).toUpperCase()+a.slice(1,a.length),t.isUndefined(n)||t["is"+a](n)||delete e[o]}}),{attributes:e,session:i}},o=function(t,e){var i=e.error;e.error=function(s){i&&i(t,s,e),t.trigger("error",t,s,e)}};return i});