!function(t,e){"use strict";"function"==typeof define&&define.amd?define(["underscore","backbone"],function(t,i){return e(t,i)}):"object"==typeof exports?module.exports=e(require("underscore"),require("backbone")):e(t._,t.Backbone)}(this,function(t,e){"use strict";var i=function(i,s){return this.properties=t.clone(this.properties||{}),this.derived=t.clone(this.derived||{}),this.session={},e.Model.call(this,i,s)};t.extend(i.prototype,e.Model.prototype,{validate:function(e,i){var n=t.keys(e),r=t.bind(s,this)(e,i);return n.length!==t.keys(r.attributes).length?new Error("One or more attributes are not valid."):void 0},toJSON:function(e){var i=this,s={};return t(this.derived).each(function(n,r){t.isFunction(n)&&(s[r]=n.call(i,e))}),t.extend(t.clone(this.attributes),t.clone(this.session),s)},get:function(e){for(var i,s=[this.attributes,this.session,this.derived],n=0,r=s.length;r>n;n+=1)if(s[n].hasOwnProperty(e)){i=s[n][e];break}return t.isFunction(i)?i.call(this):i},has:function(t){for(var e=[this.attributes,this.session,this.derived],i=0,s=e.length;s>i;i+=1)if(e[i].hasOwnProperty(t))return!0;return!1},clear:function(e){var i,s={},n=t.clone(this.session);return e=e||{},e.graceful||t.extend(n,this.attributes),t(n).each(function(t,e){s[e]=i}),this.set(s,t.extend({},e,{unset:!0}))},changedAttributes:function(e){if(!e)return this.hasChanged()?t.clone(this.changed):!1;var i,s=!1,n=this._changing?this._previousAttributes:t.extend({},this.attributes,this.session);for(var r in e)t.isEqual(n[r],i=e[r])||((s||(s={}))[r]=i);return s},set:function(e,i,n){var r,h,a,o,u,c,d,l,f;if(!e)return this;if(o=t.bind(function(e,i,s){t.isEqual(this[e][s],i)||d.push(s),t.isEqual(f[s],i)?delete this.changed[s]:this.changed[s]=i,u?delete this[e][s]:this[e][s]=i},this),t.isObject(e)?(r=e,n=i):(r={})[e]=i,n=n||{},!this._validate(r,n))return!1;if(r=t.bind(s,this)(r,n),h=r.attributes,a=r.session,u=n.unset,c=n.silent,d=[],l=this._changing,this._changing=!0,l||(this._previousAttributes=t.extend({},this.attributes,this.session),this.changed={}),f=this._previousAttributes,t.has(h,this.idAttribute)&&(this.id=h[this.idAttribute]),t(r).each(function(e,i){t(e).each(t.partial(o,i))}),!c){d.length&&(this._pending=n);for(var g=0,p=d.length;p>g;g+=1)this.trigger("change:"+d[g],this,r[d[g]]||a[d[g]],n)}if(l)return this;if(!c)for(;this._pending;)n=this._pending,this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},save:function(e,i,r){var h,a,o,u=this.attributes,c=this.session;if(t.isObject(e)?(h=e,r=i):(h={})[e]=i,r=t.extend({validate:!0},r),h&&!r.wait){if(!this.set(h,r))return!1}else if(!this._validate(h,r))return!1;h=t.bind(s,this)(h,r),h&&r.wait&&(this.attributes=t.extend({},u,h.attributes),this.session=t.extend({},c,h.session)),void 0===r.parse&&(r.parse=!0);var d=this,l=r.success;return r.success=function(e){d.attributes=u;var i=d.parse(e,r);return r.wait&&(i=t.extend(h.attributes||{},i)),t.isObject(i)&&!d.set(i,r)?!1:(l&&l(d,e,r),void d.trigger("sync",d,e,r))},n(this,r),a=this.isNew()?"create":r.patch?"patch":"update","patch"===a&&(r.attrs=h.attributes),o=this.sync(a,this,r),h.attributes&&r.wait&&(this.attributes=u),o}}),i.extend=e.Model.extend,e.IntactModel=i,e.Collection.prototype._prepareModel=function(e,i){if(t.isFunction(e.initialize))return e.collection||(e.collection=this),e;i=i||{},i.collection=this;var s=new this.model(e,i);return s._validate(e,i)?s:(this.trigger("invalid",this,e,i),!1)};var s=function(e){var i={},s=this.properties,n=this.idAttribute;return e=t.clone(e),t(e).each(function(r,h){var a,o=s[h];if(h!==n){if(t.isUndefined(o))return i[h]=r,void delete e[h];a=o.type.replace("integer","number"),a=a.slice(0,1).toUpperCase()+a.slice(1,a.length),t.isUndefined(r)||t["is"+a](r)||delete e[h]}}),{attributes:e,session:i}},n=function(t,e){var i=e.error;e.error=function(s){i&&i(t,s,e),t.trigger("error",t,s,e)}};return i});